# Telegram Bot Manager - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

**–í–µ—Ä—Å–∏—è:** 2.0.0 (Hexagonal Architecture)  
**–î–∞—Ç–∞:** 21.08.2025

## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
2. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-—Å–∏—Å—Ç–µ–º—ã)
3. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
4. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–∞–ª–µ—Ä—Ç–∏–Ω–≥)
5. [Backup –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ](#backup-–∏-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
6. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å-–∏-–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
7. [–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ](#–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ)
8. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–ø–æ–ª–∞–¥–æ–∫)

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

#### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **–û–°:** Ubuntu 20.04+ / CentOS 8+ / RHEL 8+
- **Python:** 3.9+
- **RAM:** 1GB (2GB —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- **CPU:** 1 vCPU (2+ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- **–î–∏—Å–∫:** 5GB —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- **–°–µ—Ç—å:** –î–æ—Å—Ç—É–ø –∫ api.telegram.org –∏ api.openai.com

#### –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- **–û–°:** Ubuntu 22.04 LTS / RHEL 9
- **Python:** 3.11+
- **RAM:** 4GB+ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–æ—Ç–æ–≤)
- **CPU:** 4+ vCPU
- **–î–∏—Å–∫:** 50GB+ SSD
- **–°–µ—Ç—å:** –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π IP, CDN

### –ú–µ—Ç–æ–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏

#### Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
sudo apt-get install docker-compose-plugin

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
mkdir /opt/telegram-bot-manager
cd /opt/telegram-bot-manager
```

**2. Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```yaml
# docker-compose.yml
version: '3.8'

services:
  bot-manager:
    image: telegram-bot-manager:2.0.0
    container_name: telegram-bot-manager
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - ENV=production
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://postgres:password@db:5432/telegram_bots
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./backups:/app/backups
    depends_on:
      - db
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  db:
    image: postgres:15-alpine
    container_name: telegram-bot-manager-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=telegram_bots
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    container_name: telegram-bot-manager-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"

  nginx:
    image: nginx:alpine
    container_name: telegram-bot-manager-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl/certs
    depends_on:
      - bot-manager

volumes:
  postgres_data:
  redis_data:
```

**3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
# .env
SECRET_KEY=your-very-secure-secret-key-here
POSTGRES_PASSWORD=your-secure-database-password
ADMIN_PASSWORD=your-secure-admin-password
OPENAI_API_KEY=your-openai-api-key
```

**4. –ó–∞–ø—É—Å–∫:**
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π
openssl rand -hex 32 > .secret_key

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker-compose ps
docker-compose logs -f bot-manager
```

#### Systemd —Å–µ—Ä–≤–∏—Å (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)

**1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3.11 python3.11-venv python3.11-dev
sudo apt-get install postgresql-15 redis-server nginx

# CentOS/RHEL
sudo dnf install python3.11 python3.11-pip
sudo dnf install postgresql15-server redis nginx
```

**2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```bash
sudo useradd -m -s /bin/bash telegram-bot-manager
sudo usermod -aG sudo telegram-bot-manager
```

**3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:**
```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
sudo -u telegram-bot-manager bash << 'EOF'
cd /home/telegram-bot-manager
git clone https://github.com/your-org/telegram-bot-manager.git
cd telegram-bot-manager

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3.11 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install --upgrade pip
pip install -r requirements.txt

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp config/production.env.example .env
EOF
```

**4. Systemd —Å–µ—Ä–≤–∏—Å:**
```ini
# /etc/systemd/system/telegram-bot-manager.service
[Unit]
Description=Telegram Bot Manager
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User=telegram-bot-manager
Group=telegram-bot-manager
WorkingDirectory=/home/telegram-bot-manager/telegram-bot-manager
Environment=PATH=/home/telegram-bot-manager/telegram-bot-manager/venv/bin
ExecStart=/home/telegram-bot-manager/telegram-bot-manager/venv/bin/python src/integration/unified_app.py --port 5000
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# Security settings
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/home/telegram-bot-manager/telegram-bot-manager/data
ReadWritePaths=/home/telegram-bot-manager/telegram-bot-manager/logs

[Install]
WantedBy=multi-user.target
```

**5. –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞:**
```bash
sudo systemctl daemon-reload
sudo systemctl enable telegram-bot-manager
sudo systemctl start telegram-bot-manager
sudo systemctl status telegram-bot-manager
```

### Kubernetes —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

**1. Namespace –∏ ConfigMap:**
```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: telegram-bot-manager

---
# configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: telegram-bot-manager
data:
  LOG_LEVEL: "INFO"
  ENV: "production"
  DATABASE_URL: "postgresql://postgres:password@postgres:5432/telegram_bots"
  REDIS_URL: "redis://redis:6379/0"
```

**2. Secrets:**
```yaml
# secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: telegram-bot-manager
type: Opaque
data:
  SECRET_KEY: <base64-encoded-secret>
  ADMIN_PASSWORD: <base64-encoded-password>
  POSTGRES_PASSWORD: <base64-encoded-password>
```

**3. Deployment:**
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: telegram-bot-manager
  namespace: telegram-bot-manager
spec:
  replicas: 3
  selector:
    matchLabels:
      app: telegram-bot-manager
  template:
    metadata:
      labels:
        app: telegram-bot-manager
    spec:
      containers:
      - name: app
        image: telegram-bot-manager:2.0.0
        ports:
        - containerPort: 5000
        env:
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: app-secrets
              key: SECRET_KEY
        envFrom:
        - configMapRef:
            name: app-config
        - secretRef:
            name: app-secrets
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        volumeMounts:
        - name: data
          mountPath: /app/data
        - name: logs
          mountPath: /app/logs
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: data-pvc
      - name: logs
        persistentVolumeClaim:
          claimName: logs-pvc
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã

### –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**production.env:**
```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
ENV=production
DEBUG=false
LOG_LEVEL=INFO
SECRET_KEY=your-secret-key-here

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgresql://user:password@localhost:5432/telegram_bots
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=30

# Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
REDIS_URL=redis://localhost:6379/0
CACHE_DEFAULT_TIMEOUT=300
CACHE_KEY_PREFIX=tbm:

# –í–µ–±-—Å–µ—Ä–≤–µ—Ä
HOST=0.0.0.0
PORT=5000
WORKERS=4
WORKER_CONNECTIONS=1000

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
ADMIN_USERNAME=admin
ADMIN_PASSWORD_HASH=pbkdf2:sha256:...
SESSION_TIMEOUT=3600
JWT_EXPIRE_HOURS=24

# –í–Ω–µ—à–Ω–∏–µ API
TELEGRAM_API_URL=https://api.telegram.org
OPENAI_API_URL=https://api.openai.com
HTTP_TIMEOUT=30
MAX_RETRIES=3

# –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞
DATA_DIR=/app/data
LOG_DIR=/app/logs
BACKUP_DIR=/app/backups
UPLOAD_MAX_SIZE=10485760  # 10MB

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
METRICS_ENABLED=true
METRICS_PORT=9090
HEALTH_CHECK_INTERVAL=30

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
MAX_BOTS_PER_INSTANCE=50
MESSAGE_QUEUE_SIZE=10000
WORKER_POOL_SIZE=10
```

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**logging.yaml:**
```yaml
version: 1
disable_existing_loggers: false

formatters:
  standard:
    format: '[%(asctime)s] %(levelname)s [%(name)s:%(lineno)d] %(message)s'
  json:
    class: src.monitoring.logging_system.JSONFormatter
    include_traceback: true
    include_thread_info: true

filters:
  sensitive_filter:
    class: src.monitoring.logging_system.SensitiveDataFilter
    sensitive_fields: [password, token, key, secret, auth]

handlers:
  console:
    class: logging.StreamHandler
    level: INFO
    formatter: standard
    stream: ext://sys.stdout
    filters: [sensitive_filter]
  
  file:
    class: logging.handlers.RotatingFileHandler
    level: INFO
    formatter: json
    filename: /app/logs/app.log
    maxBytes: 10485760  # 10MB
    backupCount: 10
    filters: [sensitive_filter]
  
  error_file:
    class: logging.handlers.RotatingFileHandler
    level: ERROR
    formatter: json
    filename: /app/logs/error.log
    maxBytes: 10485760
    backupCount: 5
    filters: [sensitive_filter]

loggers:
  telegram_bot_manager:
    level: INFO
    handlers: [console, file, error_file]
    propagate: false
  
  uvicorn:
    level: INFO
    handlers: [console, file]
    propagate: false
  
  sqlalchemy.engine:
    level: WARNING
    handlers: [file]
    propagate: false

root:
  level: INFO
  handlers: [console, file]
```

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**monitoring.yaml:**
```yaml
metrics:
  enabled: true
  collection_interval: 15  # seconds
  retention_hours: 24
  export_format: prometheus

alerts:
  enabled: true
  channels:
    - type: telegram
      token: BOT_TOKEN
      chat_id: ADMIN_CHAT_ID
    - type: email
      smtp_host: smtp.gmail.com
      smtp_port: 587
      username: alerts@yourdomain.com
      password: app_password
      recipients: [admin@yourdomain.com]

rules:
  - name: high_memory_usage
    metric: system.memory.percent
    operator: gt
    threshold: 80
    severity: warning
    duration: 5m
  
  - name: critical_memory_usage
    metric: system.memory.percent
    operator: gt
    threshold: 90
    severity: critical
    duration: 2m
  
  - name: high_error_rate
    metric: app.error_rate
    operator: gt
    threshold: 5  # errors per minute
    severity: critical
    duration: 1m
  
  - name: bot_down
    metric: bot.status
    operator: eq
    threshold: 0  # 0 = stopped
    severity: warning
    duration: 30s

health_checks:
  - name: database
    type: postgresql
    url: $DATABASE_URL
    timeout: 5
  
  - name: redis
    type: redis
    url: $REDIS_URL
    timeout: 3
  
  - name: telegram_api
    type: http
    url: https://api.telegram.org/bot$BOT_TOKEN/getMe
    timeout: 10
  
  - name: disk_space
    type: disk
    path: /app/data
    threshold: 90  # percent
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

#### PostgreSQL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**postgresql.conf (–æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏):**
```ini
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
work_mem = 4MB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%a.log'
log_truncate_on_rotation = on
log_rotation_age = 1d
log_rotation_size = 100MB
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_min_duration_statement = 1000  # Log slow queries

# –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è
wal_level = replica
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/archive/%f'
max_wal_senders = 3
```

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE USER telegram_bot_manager WITH PASSWORD 'secure_password';

-- –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
CREATE DATABASE telegram_bots OWNER telegram_bot_manager;

-- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
GRANT ALL PRIVILEGES ON DATABASE telegram_bots TO telegram_bot_manager;

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
\c telegram_bots
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
```

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã:**
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –±–æ—Ç–æ–≤
CREATE TABLE bots (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    token VARCHAR(512) NOT NULL UNIQUE,
    config JSONB NOT NULL DEFAULT '{}',
    status VARCHAR(50) DEFAULT 'stopped',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –¢–∞–±–ª–∏—Ü–∞ –¥–∏–∞–ª–æ–≥–æ–≤
CREATE TABLE conversations (
    id SERIAL PRIMARY KEY,
    bot_id INTEGER REFERENCES bots(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL,
    chat_id BIGINT NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(bot_id, chat_id)
);

-- –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    conversation_id INTEGER REFERENCES conversations(id) ON DELETE CASCADE,
    message_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT,
    message_type VARCHAR(50) DEFAULT 'text',
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX idx_conversations_bot_id ON conversations(bot_id);
CREATE INDEX idx_conversations_user_id ON conversations(user_id);
CREATE INDEX idx_conversations_status ON conversations(status);
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_created_at ON messages(created_at);
CREATE INDEX idx_bots_status ON bots(status);

-- –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_bots_updated_at BEFORE UPDATE ON bots
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_conversations_updated_at BEFORE UPDATE ON conversations
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞

#### Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**nginx.conf:**
```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time ut="$upstream_response_time"';
    
    access_log /var/log/nginx/access.log main;
    
    # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip —Å–∂–∞—Ç–∏–µ
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=web:10m rate=5r/s;
    
    # Upstream –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    upstream telegram_bot_manager {
        least_conn;
        server 127.0.0.1:5000 max_fails=3 fail_timeout=30s;
        server 127.0.0.1:5001 max_fails=3 fail_timeout=30s backup;
    }
    
    # HTTPS —Å–µ—Ä–≤–µ—Ä
    server {
        listen 443 ssl http2;
        server_name yourdomain.com;
        
        # SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
        ssl_certificate_key /etc/ssl/private/yourdomain.com.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_prefer_server_ciphers on;
        ssl_stapling on;
        ssl_stapling_verify on;
        
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        location / {
            limit_req zone=web burst=20 nodelay;
            
            proxy_pass http://telegram_bot_manager;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        
        # API endpoints —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º rate limiting
        location /api/ {
            limit_req zone=api burst=50 nodelay;
            
            proxy_pass http://telegram_bot_manager;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
        location /static/ {
            alias /opt/telegram-bot-manager/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # Health check
        location /health {
            access_log off;
            proxy_pass http://telegram_bot_manager;
        }
        
        # –ú–µ—Ç—Ä–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö IP)
        location /metrics {
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            allow 192.168.0.0/16;
            deny all;
            
            proxy_pass http://telegram_bot_manager;
        }
    }
    
    # HTTP —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS
    server {
        listen 80;
        server_name yourdomain.com;
        return 301 https://$server_name$request_uri;
    }
}
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

#### JWT –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT:**
```python
# –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
JWT_SECRET_KEY = 'your-jwt-secret-key'
JWT_ACCESS_TOKEN_EXPIRES = timedelta(hours=1)
JWT_REFRESH_TOKEN_EXPIRES = timedelta(days=30)
JWT_ALGORITHM = 'HS256'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cookie –¥–ª—è JWT
JWT_TOKEN_LOCATION = ['headers', 'cookies']
JWT_COOKIE_SECURE = True  # –¢–æ–ª—å–∫–æ –¥–ª—è HTTPS
JWT_COOKIE_CSRF_PROTECT = True
JWT_COOKIE_SAMESITE = 'Lax'
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏:**
```python
# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
ROLES = {
    'admin': {
        'permissions': ['*'],  # –í—Å–µ –ø—Ä–∞–≤–∞
        'description': '–ü–æ–ª–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø'
    },
    'operator': {
        'permissions': [
            'bots.read', 'bots.start', 'bots.stop',
            'conversations.read', 'system.status'
        ],
        'description': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö'
    },
    'viewer': {
        'permissions': [
            'bots.read', 'conversations.read', 'system.status'
        ],
        'description': '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö'
    }
}
```

#### –ó–∞—â–∏—Ç–∞ API endpoints

**Rate limiting:**
```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app,
    key_func=get_remote_address,
    default_limits=["1000 per hour", "100 per minute"]
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö endpoints
@app.route('/api/auth/login', methods=['POST'])
@limiter.limit("5 per minute")
def login():
    pass

@app.route('/api/bots', methods=['GET'])
@limiter.limit("60 per minute")
def list_bots():
    pass
```

**CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**
```python
from flask_cors import CORS

CORS(app, resources={
    r"/api/*": {
        "origins": ["https://yourdomain.com"],
        "methods": ["GET", "POST", "PUT", "DELETE"],
        "allow_headers": ["Content-Type", "Authorization"]
    }
})
```

### –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

#### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:**
```python
from cryptography.fernet import Fernet
import base64

class DataEncryption:
    def __init__(self, key: str):
        self.cipher = Fernet(key.encode())
    
    def encrypt(self, data: str) -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏."""
        encrypted = self.cipher.encrypt(data.encode())
        return base64.urlsafe_b64encode(encrypted).decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏."""
        encrypted = base64.urlsafe_b64decode(encrypted_data.encode())
        decrypted = self.cipher.decrypt(encrypted)
        return decrypted.decode()

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –±–æ—Ç–æ–≤
encryption = DataEncryption(ENCRYPTION_KEY)
encrypted_token = encryption.encrypt(bot_token)
```

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤:**
```python
# AWS Secrets Manager
import boto3

def get_secret(secret_name):
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# HashiCorp Vault
import hvac

def get_vault_secret(path):
    client = hvac.Client(url='https://vault.yourdomain.com')
    client.token = os.environ['VAULT_TOKEN']
    response = client.secrets.kv.v2.read_secret_version(path=path)
    return response['data']['data']

# Kubernetes Secrets
def get_k8s_secret(secret_name, key):
    with open(f'/var/run/secrets/{secret_name}/{key}', 'r') as f:
        return f.read().strip()
```

### –°–µ—Ç–µ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### Firewall –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**UFW (Ubuntu):**
```bash
# –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
sudo ufw default deny incoming
sudo ufw default allow outgoing

# –†–∞–∑—Ä–µ—à–∏—Ç—å SSH
sudo ufw allow ssh

# –†–∞–∑—Ä–µ—à–∏—Ç—å HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ nginx
sudo ufw allow from 127.0.0.1 to any port 5000

# –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
sudo ufw allow from 10.0.0.0/8 to any port 5432

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è
sudo ufw enable
```

**iptables –ø—Ä–∞–≤–∏–ª–∞:**
```bash
#!/bin/bash
# firewall.sh

# –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤–∏–ª
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X

# –ü–æ–ª–∏—Ç–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# Loopback –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# SSH (–æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ IP –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
iptables -A INPUT -p tcp --dport 22 -m state --state NEW -j ACCEPT

# HTTP/HTTPS
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT

# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ —Å localhost)
iptables -A INPUT -p tcp -s 127.0.0.1 --dport 5000 -j ACCEPT

# PostgreSQL (—Ç–æ–ª—å–∫–æ —Å –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å–µ—Ç–µ–π)
iptables -A INPUT -p tcp -s 10.0.0.0/8 --dport 5432 -j ACCEPT
iptables -A INPUT -p tcp -s 192.168.0.0/16 --dport 5432 -j ACCEPT

# Redis (—Ç–æ–ª—å–∫–æ —Å localhost)
iptables -A INPUT -p tcp -s 127.0.0.1 --dport 6379 -j ACCEPT

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª
iptables-save > /etc/iptables/rules.v4
```

#### VPN –∏ —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

**WireGuard –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:**
```ini
# /etc/wireguard/wg0.conf (—Å–µ—Ä–≤–µ—Ä)
[Interface]
PrivateKey = SERVER_PRIVATE_KEY
Address = 10.0.0.1/24
ListenPort = 51820
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# –ö–ª–∏–µ–Ω—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
[Peer]
PublicKey = ADMIN_PUBLIC_KEY
AllowedIPs = 10.0.0.2/32

# –ö–ª–∏–µ–Ω—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
[Peer]
PublicKey = MONITORING_PUBLIC_KEY
AllowedIPs = 10.0.0.3/32
```

### –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞—É–¥–∏—Ç–∞:**
```python
import logging
from datetime import datetime

security_logger = logging.getLogger('security')

class SecurityAuditFilter(logging.Filter):
    def filter(self, record):
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        record.security_event = True
        record.timestamp = datetime.utcnow().isoformat()
        return True

# –°–æ–±—ã—Ç–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞
def log_login_attempt(username, ip_address, success):
    security_logger.info(
        "Login attempt",
        extra={
            'event_type': 'login_attempt',
            'username': username,
            'ip_address': ip_address,
            'success': success,
            'user_agent': request.headers.get('User-Agent', '')
        }
    )

def log_permission_denied(username, resource, action):
    security_logger.warning(
        "Permission denied",
        extra={
            'event_type': 'permission_denied',
            'username': username,
            'resource': resource,
            'action': action,
            'ip_address': request.remote_addr
        }
    )

def log_sensitive_operation(username, operation, target):
    security_logger.info(
        "Sensitive operation",
        extra={
            'event_type': 'sensitive_operation',
            'username': username,
            'operation': operation,
            'target': target,
            'timestamp': datetime.utcnow().isoformat()
        }
    )
```

#### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–≥—Ä–æ–∑

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π:**
```python
from collections import defaultdict, deque
from datetime import datetime, timedelta
import threading

class ThreatDetector:
    def __init__(self):
        self.login_attempts = defaultdict(lambda: deque(maxlen=10))
        self.api_requests = defaultdict(lambda: deque(maxlen=100))
        self.lock = threading.RLock()
    
    def check_brute_force(self, ip_address):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ brute force –∞—Ç–∞–∫–∏."""
        with self.lock:
            now = datetime.utcnow()
            attempts = self.login_attempts[ip_address]
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –ø–æ–ø—ã—Ç–∫–∏ (—Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
            while attempts and attempts[0] < now - timedelta(hours=1):
                attempts.popleft()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
            if len(attempts) >= 5:
                self.block_ip(ip_address, reason="Brute force detected")
                return True
            
            return False
    
    def check_rate_limit_abuse(self, ip_address):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API."""
        with self.lock:
            now = datetime.utcnow()
            requests = self.api_requests[ip_address]
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å—Ç–∞—Ä—à–µ 1 –º–∏–Ω—É—Ç—ã)
            while requests and requests[0] < now - timedelta(minutes=1):
                requests.popleft()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
            if len(requests) >= 60:  # 60 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
                self.block_ip(ip_address, reason="Rate limit abuse")
                return True
            
            return False
    
    def block_ip(self, ip_address, reason):
        """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP –∞–¥—Ä–µ—Å–∞."""
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ iptables
        os.system(f"iptables -A INPUT -s {ip_address} -j DROP")
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        security_logger.critical(
            f"IP blocked: {ip_address}",
            extra={
                'event_type': 'ip_blocked',
                'ip_address': ip_address,
                'reason': reason,
                'timestamp': datetime.utcnow().isoformat()
            }
        )
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        self.notify_admin(f"IP {ip_address} blocked: {reason}")

threat_detector = ThreatDetector()
```

---

*–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...*







