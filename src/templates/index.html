<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .stats-cards .stat-card {
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stats-cards .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-box {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 10;
        }

        .search-input {
            padding-left: 45px;
            border-radius: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: #6c757d;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .filter-btn:hover {
            background: #667eea;
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        /* –°–µ—Ç–∫–∞ –±–æ—Ç–æ–≤ */
        .bots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –±–æ—Ç–æ–≤ */
        .bot-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .bot-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .bot-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .bot-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .bot-info {
            flex: 1;
        }

        .bot-name {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .bot-id {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.running {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .status-badge.stopped {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .status-badge i {
            font-size: 0.7rem;
            margin-right: 5px;
        }

        /* –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .bot-card-body {
            padding: 20px;
        }

        .bot-details {
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            color: #6c757d;
            font-weight: 500;
        }

        .detail-value {
            color: #495057;
            font-weight: 600;
        }

        /* –ë–µ–π–¥–∂–∏ —Ñ—É–Ω–∫—Ü–∏–π */
        .feature-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .feature-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .feature-badge.ai {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .feature-badge.transcriber {
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
        }

        .feature-badge.voice {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .feature-badge.marketplace {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .feature-badge.featured {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        /* –î–µ–π—Å—Ç–≤–∏—è */
        .bot-card-actions {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            color: white;
            text-decoration: none;
        }

        .action-btn.start-btn {
            background: #28a745;
        }

        .action-btn.start-btn:hover {
            background: #218838;
        }

        .action-btn.start-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.stop-btn {
            background: #ffc107;
        }

        .action-btn.stop-btn:hover {
            background: #e0a800;
        }

        .action-btn.stop-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.edit-btn {
            background: #17a2b8;
        }

        .action-btn.edit-btn:hover {
            background: #138496;
        }

        .action-btn[href*="dialogs"] {
            background: #667eea;
        }

        .action-btn[href*="dialogs"]:hover {
            background: #5a6fd8;
        }

        .action-btn[href*="marketplace"] {
            background: #fd7e14;
        }

        .action-btn[href*="marketplace"]:hover {
            background: #e8690b;
        }

        .action-btn.delete-btn {
            background: #dc3545;
        }

        .action-btn.delete-btn:hover {
            background: #c82333;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–æ—Ç–æ–≤ */
        .no-bots-message {
            text-align: center;
            padding: 60px 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .bots-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .stats-cards .row {
                margin: 0;
            }
            
            .stats-cards .col-4 {
                padding: 0 5px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-card {
            animation: fadeInUp 0.6s ease forwards;
        }

        .bot-card:nth-child(1) { animation-delay: 0.1s; }
        .bot-card:nth-child(2) { animation-delay: 0.2s; }
        .bot-card:nth-child(3) { animation-delay: 0.3s; }
        .bot-card:nth-child(4) { animation-delay: 0.4s; }
        .bot-card:nth-child(5) { animation-delay: 0.5s; }

        /* –°—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
        .status-running { color: green; font-weight: bold; }
        .status-stopped { color: red; font-weight: bold; }
        .spinner { display: none; }
        .table-responsive { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</h1>
    <div class="alert alert-success mb-4" role="alert">
        <i class="fas fa-sync-alt"></i> <strong>AUTO-UPDATE TEST v3.1.2:</strong> –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
        <br><strong>‚ö° RESTART NEEDED:</strong> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π!
    </div>
    <div class="alert alert-warning" role="alert">
        ‚ö† –í–Ω–∏–º–∞–Ω–∏–µ: –ò–∑–º–µ–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ src/app.py (—Ä–∞–∑–¥–µ–ª USERS) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!
    </div>
    
    <!-- Navigation -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <a href="/marketplace" class="btn btn-outline-primary btn-sm me-2">
                <i class="fas fa-store"></i> ElectroNick bot Market
            </a>
            <a href="/api/v2/docs" class="btn btn-outline-info btn-sm me-2" target="_blank">
                <i class="fas fa-book"></i> API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
            </a>
        </div>
        <div>
            <span class="text-muted me-3">
                <i class="fas fa-user"></i> 
                <span id="currentUser">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
            </span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
            </button>
        </div>
    </div>
    
    <!-- Version Info -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="text-muted small">
            <i class="fas fa-code-branch"></i> –í–µ—Ä—Å–∏—è: 
            <span class="fw-bold">{{ version }}</span>
            {% if version_details.is_dev %}
                <span class="badge bg-warning text-dark ms-1">DEV</span>
            {% endif %}
            <button class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal" data-bs-target="#versionModal">
                <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </button>
        </div>
        <div>
            <div class="btn-group me-2" role="group">
                <button id="checkUpdatesBtn" class="btn btn-outline-primary btn-sm" onclick="checkForUpdates()">
                    <i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleUpdateDetails()" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                    <i class="fas fa-chevron-down" id="detailsIcon"></i>
                </button>
            </div>
            <button id="updateBtn" class="btn btn-success btn-sm me-2" onclick="performUpdate()" style="display: none;">
                <i class="fas fa-download"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="btn btn-outline-warning btn-sm" onclick="showBackupManager()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏">
                <i class="fas fa-archive"></i> –ë—ç–∫–∞–ø—ã
            </button>
            
            <!-- Update Status Section -->
            <div id="updateDetails" class="mt-2" style="display: none;">
                <div id="updateStatus" class="text-muted small mb-2" style="display: none;"></div>
                
                <!-- Progress Bar -->
                <div id="progressContainer" class="mb-2" style="display: none;">
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    <div id="progressMessage" class="small text-muted mt-1"></div>
                </div>
                
                <!-- Update Info -->
                <div id="updateInfo" class="small" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</strong> <span id="currentCommit">-</span>
                        </div>
                        <div class="col-md-6">
                            <strong>–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:</strong> <span id="remoteCommit">-</span>
                        </div>
                    </div>
                    <div id="commitList" class="mt-2" style="display: none;">
                        <strong>–ò–∑–º–µ–Ω–µ–Ω–∏—è:</strong>
                        <ul id="commitLogList" class="small mb-0"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</div>
        <div class="card-body">
            <form id="createBotForm">
                <div class="row g-3">
                    <div class="col-md-6"><input type="text" class="form-control" id="bot_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="telegram_token" placeholder="Telegram Token" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="openai_api_key" placeholder="OpenAI API Key" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="assistant_id" placeholder="Assistant ID" required></div>
                    <div class="col-md-6">
                        <input type="number" class="form-control" id="group_context_limit" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15)" min="5" max="50" value="15">
                        <small class="form-text text-muted">–°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="enable_ai_responses" value="true" checked>
                            <label class="form-check-label" for="enable_ai_responses">
                                üß† –ò–ò –æ—Ç–≤–µ—Ç—ã
                            </label>
                        </div>
                        <small class="form-text text-muted">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ OpenAI (–æ—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏)</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable_voice_responses" value="true">
                            <label class="form-check-label" for="enable_voice_responses">
                                üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
                            </label>
                        </div>
                        <small class="form-text text-muted">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≥–æ–ª–æ—Å–æ–º —á–µ—Ä–µ–∑ TTS</small>
                    </div>
                    <div class="col-md-6" id="voice_settings" style="display: none;">
                        <label class="form-label">–ú–æ–¥–µ–ª—å –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="voice_model">
                            <option value="tts-1">TTS-1 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                            <option value="tts-1-hd">TTS-1-HD (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
                        </select>
                    </div>
                    <div class="col-md-6" id="voice_type_settings" style="display: none;">
                        <label class="form-label">–¢–∏–ø –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="voice_type">
                            <option value="alloy">Alloy (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)</option>
                            <option value="echo">Echo (–º—É–∂—Å–∫–æ–π)</option>
                            <option value="fable">Fable (–±—Ä–∏—Ç–∞–Ω—Å–∫–∏–π)</option>
                            <option value="onyx">Onyx (–º—É–∂—Å–∫–æ–π, –≥–ª—É–±–æ–∫–∏–π)</option>
                            <option value="nova">Nova (–∂–µ–Ω—Å–∫–∏–π, –º–æ–ª–æ–¥–æ–π)</option>
                            <option value="shimmer">Shimmer (–∂–µ–Ω—Å–∫–∏–π, –º—è–≥–∫–∏–π)</option>
                        </select>
                    </div>
                    
                    <!-- Marketplace Settings -->
                    <div class="col-12">
                        <hr class="my-3">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="marketplace_enabled" value="true">
                            <label class="form-check-label" for="marketplace_enabled">
                                <strong>üè™ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ</strong>
                            </label>
                            <small class="form-text text-muted d-block">–°–¥–µ–ª–∞—Ç—å –±–æ—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤ –ø—É–±–ª–∏—á–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ</small>
                        </div>
                    </div>
                    
                    <!-- Marketplace Fields (initially hidden) -->
                    <div id="marketplace_fields" style="display: none;">
                        <div class="col-md-6">
                            <label class="form-label">üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞</label>
                            <input type="text" class="form-control" id="marketplace_title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ">
                            <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –±–æ—Ç–∞</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select class="form-select" id="marketplace_category">
                                <option value="assistant">ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã</option>
                                <option value="business">üíº –ë–∏–∑–Ω–µ—Å</option>
                                <option value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                                <option value="entertainment">üéÆ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                                <option value="productivity">‚ö° –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</option>
                                <option value="support">üõ†Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                                <option value="social">üë• –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ</option>
                                <option value="news">üì∞ –ù–æ–≤–æ—Å—Ç–∏</option>
                                <option value="finance">üí∞ –§–∏–Ω–∞–Ω—Å—ã</option>
                                <option value="health">üè• –ó–¥–æ—Ä–æ–≤—å–µ</option>
                                <option value="travel">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                                <option value="food">üçï –ï–¥–∞</option>
                                <option value="other" selected>üì¶ –î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="marketplace_description" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üë§ Username –±–æ—Ç–∞</label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" id="marketplace_username" placeholder="bot_username">
                            </div>
                            <small class="form-text text-muted">–ò–º—è –±–æ—Ç–∞ –≤ Telegram (–±–µ–∑ @)</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üåê –í–µ–±-—Å–∞–π—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input type="url" class="form-control" id="marketplace_website" placeholder="https://example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üñºÔ∏è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input type="url" class="form-control" id="marketplace_image_url" placeholder="https://example.com/bot-avatar.jpg">
                            <small class="form-text text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 300x300px</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üè∑Ô∏è –¢–µ–≥–∏</label>
                            <input type="text" class="form-control" id="marketplace_tags" placeholder="–ø–æ–º–æ—â–Ω–∏–∫, —á–∞—Ç, AI">
                            <small class="form-text text-muted">–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –ø–æ–∏—Å–∫–∞</small>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="marketplace_featured" value="true">
                                <label class="form-check-label" for="marketplace_featured">
                                    ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –±–æ—Ç
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">‚≠ê –†–µ–π—Ç–∏–Ω–≥ (0-5)</label>
                            <input type="number" class="form-control" id="marketplace_rating" min="0" max="5" step="0.1" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">üë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                            <input type="number" class="form-control" id="marketplace_total_users" min="0" value="0">
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="createBtn">
                            <span class="spinner-border spinner-border-sm spinner" role="status"></span> –°–æ–∑–¥–∞—Ç—å
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- –ë–æ—Ç—ã Dashboard -->
    <div class="bots-dashboard">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="dashboard-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="mb-0">
                        <i class="fas fa-robot text-primary"></i>
                        –°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤
                    </h2>
                    <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Telegram –±–æ—Ç–æ–≤</p>
                </div>
                <div class="col-md-6">
                    <div class="stats-cards">
                        <div class="row g-2">
                            <div class="col-4">
                                <div class="stat-card bg-primary text-white">
                                    <div class="stat-number" id="totalBots">{{ bots|length }}</div>
                                    <div class="stat-label">–í—Å–µ–≥–æ –±–æ—Ç–æ–≤</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card bg-success text-white">
                                    <div class="stat-number" id="runningBots">{{ bots|selectattr('status', 'equalto', 'running')|list|length }}</div>
                                    <div class="stat-label">–†–∞–±–æ—Ç–∞—é—Ç</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-card bg-info text-white">
                                    <div class="stat-number" id="marketplaceBots">{{ bots|selectattr('config.marketplace.enabled', 'equalto', true)|list|length }}</div>
                                    <div class="stat-label">–í –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
        <div class="filters-section mb-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="form-control search-input" id="searchBots" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –±–æ—Ç–∞...">
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">
                            <i class="fas fa-list"></i> –í—Å–µ
                        </button>
                        <button class="filter-btn" data-filter="running">
                            <i class="fas fa-play-circle"></i> –†–∞–±–æ—Ç–∞—é—â–∏–µ
                        </button>
                        <button class="filter-btn" data-filter="stopped">
                            <i class="fas fa-pause-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ
                        </button>
                        <button class="filter-btn" data-filter="marketplace">
                            <i class="fas fa-store"></i> –í –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ
                        </button>
                        <button class="filter-btn" data-filter="ai">
                            <i class="fas fa-brain"></i> –ò–ò –±–æ—Ç—ã
                        </button>
                        <button class="filter-btn" data-filter="transcriber">
                            <i class="fas fa-microphone"></i> –¢—Ä–∞–Ω—Å–∫—Ä–∞–π–±–µ—Ä—ã
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
        <div class="bots-grid" id="botsGrid">
            {% for bot in bots %}
            <div class="bot-card" data-bot-id="{{ bot.id }}" data-status="{{ bot.status }}" data-ai="{{ bot.config.get('enable_ai_responses', True) }}" data-marketplace="{{ bot.config.get('marketplace', {}).get('enabled', False) }}">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="bot-card-header">
                    <div class="bot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bot-info">
                        <h5 class="bot-name">{{ bot.config.bot_name }}</h5>
                        <div class="bot-id">ID: {{ bot.id }}</div>
                    </div>
                    <div class="bot-status-indicator">
                        {% if bot.status == 'running' %}
                            <span class="status-badge running">
                                <i class="fas fa-circle"></i> –†–∞–±–æ—Ç–∞–µ—Ç
                            </span>
                        {% else %}
                            <span class="status-badge stopped">
                                <i class="fas fa-circle"></i> –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                            </span>
                        {% endif %}
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="bot-card-body">
                    <div class="bot-details">
                        <div class="detail-item">
                            <span class="detail-label">Assistant ID:</span>
                            <span class="detail-value">{{ bot.config.assistant_id[:20] }}...</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">–ö–æ–Ω—Ç–µ–∫—Å—Ç:</span>
                            <span class="detail-value">{{ bot.config.group_context_limit or 15 }} —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                        </div>
                    </div>

                    <!-- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å -->
                    <div class="bot-features">
                        <div class="feature-badges">
                            {% if bot.config.get('enable_ai_responses', True) %}
                                <span class="feature-badge ai">
                                    <i class="fas fa-brain"></i> –ò–ò
                                </span>
                            {% else %}
                                <span class="feature-badge transcriber">
                                    <i class="fas fa-microphone"></i> –¢—Ä–∞–Ω—Å–∫—Ä–∞–π–±–µ—Ä
                                </span>
                            {% endif %}

                            {% if bot.config.enable_voice_responses %}
                                <span class="feature-badge voice">
                                    <i class="fas fa-volume-up"></i> TTS
                                </span>
                            {% endif %}

                            {% if bot.config.get('marketplace', {}).get('enabled', False) %}
                                <span class="feature-badge marketplace">
                                    <i class="fas fa-store"></i> –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å
                                </span>
                                {% if bot.config.marketplace.get('featured', False) %}
                                    <span class="feature-badge featured">
                                        <i class="fas fa-star"></i> Featured
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="bot-card-actions">
                    <div class="action-buttons">
                        <button class="action-btn start-btn" {% if bot.status == 'running' %}disabled{% endif %} title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn stop-btn" {% if bot.status != 'running' %}disabled{% endif %} title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="action-btn edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="/dialogs/{{ bot.id }}" class="action-btn" title="–î–∏–∞–ª–æ–≥–∏">
                            <i class="fas fa-comments"></i>
                        </a>
                        {% if bot.config.get('marketplace', {}).get('enabled', False) %}
                            <a href="/marketplace/{{ bot.id }}" class="action-btn" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ">
                                <i class="fas fa-store"></i>
                            </a>
                        {% endif %}
                        <button class="action-btn delete-btn" title="–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –±–æ—Ç–æ–≤ -->
        <div id="noBots" class="no-bots-message" style="display: none;">
            <div class="text-center py-5">
                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">–ë–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="editBotForm">
                <input type="hidden" id="edit_bot_id">
                <div class="mb-3"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="form-control" id="edit_bot_name" required></div>
                <div class="mb-3"><label class="form-label">Telegram Token</label><input type="text" class="form-control" id="edit_telegram_token" required></div>
                <div class="mb-3"><label class="form-label">OpenAI API Key</label><input type="text" class="form-control" id="edit_openai_api_key" required></div>
                <div class="mb-3"><label class="form-label">Assistant ID</label><input type="text" class="form-control" id="edit_assistant_id" required></div>
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</label>
                    <input type="number" class="form-control" id="edit_group_context_limit" min="5" max="50" value="15">
                    <small class="form-text text-muted">–°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö</small>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_enable_ai_responses" value="true" checked>
                        <label class="form-check-label" for="edit_enable_ai_responses">
                            üß† –ò–ò –æ—Ç–≤–µ—Ç—ã
                        </label>
                    </div>
                    <small class="form-text text-muted">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ OpenAI (–æ—Ç–∫–ª—é—á–∏—Ç–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏)</small>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_enable_voice_responses" value="true">
                        <label class="form-check-label" for="edit_enable_voice_responses">
                            üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
                        </label>
                    </div>
                    <small class="form-text text-muted">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≥–æ–ª–æ—Å–æ–º —á–µ—Ä–µ–∑ TTS</small>
                </div>
                <div class="row" id="edit_voice_settings" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label">–ú–æ–¥–µ–ª—å –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="edit_voice_model">
                            <option value="tts-1">TTS-1 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                            <option value="tts-1-hd">TTS-1-HD (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">–¢–∏–ø –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="edit_voice_type">
                            <option value="alloy">Alloy (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)</option>
                            <option value="echo">Echo (–º—É–∂—Å–∫–æ–π)</option>
                            <option value="fable">Fable (–±—Ä–∏—Ç–∞–Ω—Å–∫–∏–π)</option>
                            <option value="onyx">Onyx (–º—É–∂—Å–∫–æ–π, –≥–ª—É–±–æ–∫–∏–π)</option>
                            <option value="nova">Nova (–∂–µ–Ω—Å–∫–∏–π, –º–æ–ª–æ–¥–æ–π)</option>
                            <option value="shimmer">Shimmer (–∂–µ–Ω—Å–∫–∏–π, –º—è–≥–∫–∏–π)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Marketplace Settings -->
                <hr class="my-3">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_marketplace_enabled" value="true">
                        <label class="form-check-label" for="edit_marketplace_enabled">
                            <strong>üè™ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ</strong>
                        </label>
                    </div>
                    <small class="form-text text-muted">–°–¥–µ–ª–∞—Ç—å –±–æ—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–º –≤ –ø—É–±–ª–∏—á–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ</small>
                </div>
                
                <!-- Marketplace Fields (initially hidden) -->
                <div id="edit_marketplace_fields" style="display: none;">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞</label>
                            <input type="text" class="form-control" id="edit_marketplace_title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                            <select class="form-select" id="edit_marketplace_category">
                                <option value="assistant">ü§ñ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã</option>
                                <option value="business">üíº –ë–∏–∑–Ω–µ—Å</option>
                                <option value="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</option>
                                <option value="entertainment">üéÆ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                                <option value="productivity">‚ö° –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</option>
                                <option value="support">üõ†Ô∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                                <option value="social">üë• –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ</option>
                                <option value="news">üì∞ –ù–æ–≤–æ—Å—Ç–∏</option>
                                <option value="finance">üí∞ –§–∏–Ω–∞–Ω—Å—ã</option>
                                <option value="health">üè• –ó–¥–æ—Ä–æ–≤—å–µ</option>
                                <option value="travel">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                                <option value="food">üçï –ï–¥–∞</option>
                                <option value="other">üì¶ –î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">üìÑ –û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="edit_marketplace_description" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –±–æ—Ç–∞"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üë§ Username –±–æ—Ç–∞</label>
                            <div class="input-group">
                                <span class="input-group-text">@</span>
                                <input type="text" class="form-control" id="edit_marketplace_username" placeholder="bot_username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üåê –í–µ–±-—Å–∞–π—Ç</label>
                            <input type="url" class="form-control" id="edit_marketplace_website" placeholder="https://example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üñºÔ∏è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                            <input type="url" class="form-control" id="edit_marketplace_image_url" placeholder="https://example.com/bot-avatar.jpg">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">üè∑Ô∏è –¢–µ–≥–∏</label>
                            <input type="text" class="form-control" id="edit_marketplace_tags" placeholder="–ø–æ–º–æ—â–Ω–∏–∫, —á–∞—Ç, AI">
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="edit_marketplace_featured" value="true">
                                <label class="form-check-label" for="edit_marketplace_featured">
                                    ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">‚≠ê –†–µ–π—Ç–∏–Ω–≥</label>
                            <input type="number" class="form-control" id="edit_marketplace_rating" min="0" max="5" step="0.1" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            <input type="number" class="form-control" id="edit_marketplace_total_users" min="0" value="0">
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" id="saveEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div></div>
</div>

<!-- Version Details Modal -->
<div class="modal fade" id="versionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-tag text-success"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏—è:</strong></td>
                                <td>{{ version_details.version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í–µ—Ç–∫–∞:</strong></td>
                                <td>
                                    <span class="badge bg-{% if version_details.branch == 'main' %}success{% else %}warning{% endif %}">
                                        {{ version_details.branch }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–¢–∏–ø —Å–±–æ—Ä–∫–∏:</strong></td>
                                <td>
                                    {% if version_details.is_dev %}
                                        <span class="badge bg-warning text-dark">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞</span>
                                    {% else %}
                                        <span class="badge bg-success">–ü—Ä–æ–¥–∞–∫—à–Ω</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-code-branch text-info"></i> Git –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ö–æ–º–º–∏—Ç:</strong></td>
                                <td><code>{{ version_details.commit_hash }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>–î–∞—Ç–∞ –∫–æ–º–º–∏—Ç–∞:</strong></td>
                                <td>{{ version_details.commit_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></td>
                                <td class="text-muted small">{{ version_details.commit_message[:50] }}{% if version_details.commit_message|length > 50 %}...{% endif %}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs text-secondary"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Python:</strong></td>
                                <td>{{ version_details.python_version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:</strong></td>
                                <td>{{ version_details.build_time }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-rocket text-primary"></i> –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</li>
                            <li><i class="fas fa-check text-success"></i> OpenAI Assistant API</li>
                            <li><i class="fas fa-check text-success"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</li>
                            <li><i class="fas fa-check text-success"></i> –ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</li>
                            <li><i class="fas fa-check text-success"></i> –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="checkForUpdates()">
                    <i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Backup Manager Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-archive text-warning"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞–º–∏
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">–î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã</h6>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="refreshBackupList()">
                            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="cleanupBackups()">
                            <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∫–∞
                        </button>
                    </div>
                </div>
                
                <div id="backupLoading" class="text-center py-4" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –±—ç–∫–∞–ø–æ–≤...
                </div>
                
                <div id="backupsList">
                    <!-- Backup list will be loaded here -->
                </div>
                
                <div id="noBackups" class="text-center text-muted py-4" style="display: none;">
                    <i class="fas fa-archive"></i>
                    <p class="mb-0">–ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <small>–ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-info" onclick="showBackupInfo()">
                    <i class="fas fa-info-circle"></i> –û –±—ç–∫–∞–ø–∞—Ö
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    function apiCall(url, method, data, btn) {
        if (btn) $(btn).prop('disabled', true);
        $.ajax({
            url: url, method: method, contentType: "application/json", data: JSON.stringify(data),
            success: () => location.reload(),
            error: (xhr) => {
                alert("–û—à–∏–±–∫–∞: " + (xhr.responseJSON?.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                if (btn) $(btn).prop('disabled', false);
            }
        });
    }
    $("#createBotForm").submit(e => {
        e.preventDefault();
        
        // Parse tags
        const tags = $("#marketplace_tags").val() ? 
            $("#marketplace_tags").val().split(',').map(tag => tag.trim()).filter(tag => tag) : [];
        
        const botData = {
            bot_name: $("#bot_name").val(), 
            telegram_token: $("#telegram_token").val(),
            openai_api_key: $("#openai_api_key").val(), 
            assistant_id: $("#assistant_id").val(),
            group_context_limit: parseInt($("#group_context_limit").val()) || 15,
            enable_ai_responses: $("#enable_ai_responses").is(':checked'),
            enable_voice_responses: $("#enable_voice_responses").is(':checked'),
            voice_model: $("#voice_model").val() || "tts-1",
            voice_type: $("#voice_type").val() || "alloy"
        };
        
        // Add marketplace data if enabled
        if ($("#marketplace_enabled").is(':checked')) {
            botData.marketplace = {
                enabled: true,
                title: $("#marketplace_title").val() || "",
                description: $("#marketplace_description").val() || "",
                category: $("#marketplace_category").val() || "other",
                username: $("#marketplace_username").val() || "",
                website: $("#marketplace_website").val() || "",
                image_url: $("#marketplace_image_url").val() || "",
                tags: tags,
                featured: $("#marketplace_featured").is(':checked'),
                rating: parseFloat($("#marketplace_rating").val()) || 0,
                total_users: parseInt($("#marketplace_total_users").val()) || 0,
                last_updated: new Date().toISOString().split('T')[0]
            };
        }
        
        apiCall("/api/bots", "POST", botData, '#createBtn');
    });
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫ –±–æ—Ç–æ–≤
    function filterBots() {
        const searchTerm = $('#searchBots').val().toLowerCase();
        const activeFilter = $('.filter-btn.active').data('filter');
        
        $('.bot-card').each(function() {
            const card = $(this);
            const botName = card.find('.bot-name').text().toLowerCase();
            const botStatus = card.data('status');
            const botAI = card.data('ai');
            const botMarketplace = card.data('marketplace');
            
            let matchesSearch = botName.includes(searchTerm);
            let matchesFilter = true;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            switch(activeFilter) {
                case 'running':
                    matchesFilter = botStatus === 'running';
                    break;
                case 'stopped':
                    matchesFilter = botStatus === 'stopped';
                    break;
                case 'marketplace':
                    matchesFilter = botMarketplace === true;
                    break;
                case 'ai':
                    matchesFilter = botAI === true;
                    break;
                case 'transcriber':
                    matchesFilter = botAI === false;
                    break;
                case 'all':
                default:
                    matchesFilter = true;
                    break;
            }
            
            if (matchesSearch && matchesFilter) {
                card.show();
            } else {
                card.hide();
            }
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const visibleCards = $('.bot-card:visible').length;
        if (visibleCards === 0) {
            $('#noBots').show();
        } else {
            $('#noBots').hide();
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–∞
    $('#searchBots').on('input', filterBots);
    
    $('.filter-btn').on('click', function() {
        $('.filter-btn').removeClass('active');
        $(this).addClass('active');
        filterBots();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –±–æ—Ç–æ–≤
    $('#botsGrid').on('click', '.edit-btn', function() {
        var card = $(this).closest('.bot-card');
        var botId = card.data("bot-id");
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        $.get(`/api/bots/${botId}`)
            .done(function(bot) {
                $("#edit_bot_id").val(bot.id);
                $("#edit_bot_name").val(bot.config.bot_name);
                $("#edit_telegram_token").val(bot.config.telegram_token);
                $("#edit_openai_api_key").val(bot.config.openai_api_key);
                $("#edit_assistant_id").val(bot.config.assistant_id);
                $("#edit_group_context_limit").val(bot.config.group_context_limit || 15);
                
                // –ò–ò –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                $("#edit_enable_ai_responses").prop('checked', bot.config.enable_ai_responses !== false);
                
                // TTS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                $("#edit_enable_voice_responses").prop('checked', bot.config.enable_voice_responses || false);
                $("#edit_voice_model").val(bot.config.voice_model || "tts-1");
                $("#edit_voice_type").val(bot.config.voice_type || "alloy");
                
                // Marketplace –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const marketplace = bot.config.marketplace || {};
                $("#edit_marketplace_enabled").prop('checked', marketplace.enabled || false);
                $("#edit_marketplace_title").val(marketplace.title || "");
                $("#edit_marketplace_description").val(marketplace.description || "");
                $("#edit_marketplace_category").val(marketplace.category || "other");
                $("#edit_marketplace_username").val(marketplace.username || "");
                $("#edit_marketplace_website").val(marketplace.website || "");
                $("#edit_marketplace_image_url").val(marketplace.image_url || "");
                $("#edit_marketplace_tags").val((marketplace.tags || []).join(', '));
                $("#edit_marketplace_featured").prop('checked', marketplace.featured || false);
                $("#edit_marketplace_rating").val(marketplace.rating || 0);
                $("#edit_marketplace_total_users").val(marketplace.total_users || 0);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (bot.config.enable_voice_responses) {
                    $("#edit_voice_settings").show();
                } else {
                    $("#edit_voice_settings").hide();
                }
                
                if (marketplace.enabled) {
                    $("#edit_marketplace_fields").show();
                } else {
                    $("#edit_marketplace_fields").hide();
                }
                
                new bootstrap.Modal('#editModal').show();
            })
            .fail(function() {
                // Fallback –∫ —Å—Ç–∞—Ä–æ–º—É –º–µ—Ç–æ–¥—É –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                $("#edit_bot_id").val(botId);
                $("#edit_bot_name").val(row.find(".bot-name").text());
                $("#edit_telegram_token").val(row.find(".bot-token").text());
                $("#edit_openai_api_key").val(row.find(".bot-openai").text());
                $("#edit_assistant_id").val(row.find(".bot-assistant").text());
                $("#edit_group_context_limit").val(row.find(".bot-context").text() || 15);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                $("#edit_enable_ai_responses").prop('checked', true); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ò–ò –≤–∫–ª—é—á–µ–Ω—ã
                $("#edit_enable_voice_responses").prop('checked', false);
                $("#edit_voice_model").val("tts-1");
                $("#edit_voice_type").val("alloy");
                $("#edit_voice_settings").hide();
                
                new bootstrap.Modal('#editModal').show();
            });
    });
    $("#editBotForm").submit(e => {
        e.preventDefault();
        var botId = $("#edit_bot_id").val();
        
        // Parse tags
        const editTags = $("#edit_marketplace_tags").val() ? 
            $("#edit_marketplace_tags").val().split(',').map(tag => tag.trim()).filter(tag => tag) : [];
        
        const editBotData = {
            bot_name: $("#edit_bot_name").val(), 
            telegram_token: $("#edit_telegram_token").val(),
            openai_api_key: $("#edit_openai_api_key").val(), 
            assistant_id: $("#edit_assistant_id").val(),
            group_context_limit: parseInt($("#edit_group_context_limit").val()) || 15,
            enable_ai_responses: $("#edit_enable_ai_responses").is(':checked'),
            enable_voice_responses: $("#edit_enable_voice_responses").is(':checked'),
            voice_model: $("#edit_voice_model").val() || "tts-1",
            voice_type: $("#edit_voice_type").val() || "alloy"
        };
        
        // Add marketplace data
        editBotData.marketplace = {
            enabled: $("#edit_marketplace_enabled").is(':checked'),
            title: $("#edit_marketplace_title").val() || "",
            description: $("#edit_marketplace_description").val() || "",
            category: $("#edit_marketplace_category").val() || "other",
            username: $("#edit_marketplace_username").val() || "",
            website: $("#edit_marketplace_website").val() || "",
            image_url: $("#edit_marketplace_image_url").val() || "",
            tags: editTags,
            featured: $("#edit_marketplace_featured").is(':checked'),
            rating: parseFloat($("#edit_marketplace_rating").val()) || 0,
            total_users: parseInt($("#edit_marketplace_total_users").val()) || 0,
            last_updated: new Date().toISOString().split('T')[0]
        };
        
        apiCall(`/api/bots/${botId}`, "PUT", editBotData, '#saveEditBtn');
    });
    $('#botsGrid').on('click', '.delete-btn', function() {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞?")) apiCall(`/api/bots/${$(this).closest('.bot-card').data('bot-id')}`, "DELETE", null, this);
    });
    $('#botsGrid').on('click', '.start-btn', function() { apiCall(`/api/bots/${$(this).closest('.bot-card').data('bot-id')}/start`, "POST", null, this); });
    $('#botsGrid').on('click', '.stop-btn', function() { apiCall(`/api/bots/${$(this).closest('.bot-card').data('bot-id')}/stop`, "POST", null, this); });
    
    // –°—Ç–∞—Ä—ã–π –ø–æ–∏—Å–∫ –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
    // $("#searchBots").on("keyup", function() {
    //     var value = $(this).val().toLowerCase();
    //     $("#botsTable tbody tr").toggle(function() { return $(this).find(".bot-name").text().toLowerCase().indexOf(value) > -1; });
    // });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è)
    $("#enable_voice_responses").change(function() {
        if ($(this).is(':checked')) {
            $("#voice_settings, #voice_type_settings").show();
        } else {
            $("#voice_settings, #voice_type_settings").hide();
        }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    $("#edit_enable_voice_responses").change(function() {
        if ($(this).is(':checked')) {
            $("#edit_voice_settings").show();
        } else {
            $("#edit_voice_settings").hide();
        }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å marketplace –ø–æ–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è)
    $("#marketplace_enabled").change(function() {
        if ($(this).is(':checked')) {
            $("#marketplace_fields").show();
        } else {
            $("#marketplace_fields").hide();
        }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å marketplace –ø–æ–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    $("#edit_marketplace_enabled").change(function() {
        if ($(this).is(':checked')) {
            $("#edit_marketplace_fields").show();
        } else {
            $("#edit_marketplace_fields").hide();
        }
    });
});

function checkForUpdates() {
    const btn = document.getElementById('checkUpdatesBtn');
    const updateBtn = document.getElementById('updateBtn');
    const statusDiv = document.getElementById('updateStatus');
    const updateInfo = document.getElementById('updateInfo');
    const currentCommit = document.getElementById('currentCommit');
    const remoteCommit = document.getElementById('remoteCommit');
    const commitList = document.getElementById('commitList');
    const commitLogList = document.getElementById('commitLogList');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    btn.disabled = true;
    updateBtn.style.display = 'none';
    statusDiv.style.display = 'none';
    updateInfo.style.display = 'none';
    
    $.get('/api/check-updates')
        .done(function(data) {
            if (data.has_updates) {
                // Show update info
                currentCommit.textContent = data.local_commit || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                remoteCommit.textContent = data.remote_commit || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                
                // Show commit log if available
                if (data.commit_log && data.commit_log.length > 0) {
                    commitLogList.innerHTML = '';
                    data.commit_log.forEach(commit => {
                        const li = document.createElement('li');
                        li.textContent = commit;
                        commitLogList.appendChild(li);
                    });
                    commitList.style.display = 'block';
                } else {
                    commitList.style.display = 'none';
                }
                
                statusDiv.innerHTML = '<i class="fas fa-arrow-up text-success"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ!';
                statusDiv.style.display = 'block';
                updateBtn.style.display = 'inline-block';
                updateInfo.style.display = 'block';
                
                // Auto-expand details if collapsed
                const updateDetails = document.getElementById('updateDetails');
                if (updateDetails.style.display === 'none') {
                    toggleUpdateDetails();
                }
                
            } else {
                statusDiv.innerHTML = '<i class="fas fa-check text-success"></i> –£ –≤–∞—Å –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è!';
                statusDiv.style.display = 'block';
                updateBtn.style.display = 'none';
                updateInfo.style.display = 'none';
            }
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> –û—à–∏–±–∫–∞: ${error}`;
            statusDiv.style.display = 'block';
            updateInfo.style.display = 'none';
        })
        .always(function() {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
            btn.disabled = false;
        });
}

function performUpdate() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?\n\nüîí –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï:\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞\n‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –±–æ—Ç–æ–≤\n‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n‚Ä¢ –ù–∞–¥–µ–∂–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        return;
    }
    
    const btn = document.getElementById('updateBtn');
    const checkBtn = document.getElementById('checkUpdatesBtn');
    const statusDiv = document.getElementById('updateStatus');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    
    // Initialize progress
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    btn.disabled = true;
    checkBtn.disabled = true;
    
    statusDiv.innerHTML = '<i class="fas fa-rocket text-primary"></i> –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    statusDiv.style.display = 'block';
    
    // Show progress bar
    progressContainer.style.display = 'block';
    updateProgress(0, '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
    
    // Auto-expand details if collapsed
    const updateDetails = document.getElementById('updateDetails');
    if (updateDetails.style.display === 'none') {
        toggleUpdateDetails();
    }
    
    // Start update process
    updateProgress(5, '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é...');
    
    $.post('/api/update')
        .done(function(data) {
            updateProgress(100, '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
            
            statusDiv.innerHTML = `<i class="fas fa-check-circle text-success"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! 
                                   ${data.backup_id ? `(–ë—ç–∫–∞–ø: ${data.backup_id})` : ''}`;
            
            // Show success message
            setTimeout(() => {
                if(confirm(`‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!\n\nüì¶ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: ${data.backup_id || 'N/A'}\nüîÑ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${data.new_version || 'N/A'}\n\nüîÑ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è.\n–°—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥.\n\n–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ–π—á–∞—Å?`)) {
                    window.location.reload();
                } else {
                    // Auto reload after delay
                    progressMessage.innerHTML = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥...';
                    setTimeout(() => window.location.reload(), 10000);
                }
            }, 1000);
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            const backupId = xhr.responseJSON ? xhr.responseJSON.backup_id : null;
            
            updateProgress(0, `–û—à–∏–±–∫–∞: ${error}`);
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            
            statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                                   ${backupId ? `(–î–æ—Å—Ç—É–ø–µ–Ω rollback: ${backupId})` : ''}`;
            
            alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ${error}${backupId ? `\n\nüîÑ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${backupId}\n–ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å rollback —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ç–∫–∞–ø–æ–≤.` : ''}`);
            
            btn.innerHTML = '<i class="fas fa-download"></i> –û–±–Ω–æ–≤–∏—Ç—å';
            btn.disabled = false;
            checkBtn.disabled = false;
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('progress-bar-animated');
            }, 3000);
        });
    
    // Start progress monitoring
    startUpdateProgressMonitoring();
}

function updateProgress(percent, message) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressMessage = document.getElementById('progressMessage');
    
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    progressText.textContent = percent + '%';
    progressMessage.textContent = message;
}

function startUpdateProgressMonitoring() {
    const checkProgress = () => {
        $.get('/api/update/status')
            .done(function(response) {
                if (response.success && response.data) {
                    const status = response.data;
                    
                    if (status.is_in_progress) {
                        updateProgress(status.progress, status.message);
                        
                        // Continue monitoring
                        setTimeout(checkProgress, 1000);
                    }
                }
            })
            .fail(() => {
                // If status endpoint fails, stop monitoring
                // (Normal during restart)
            });
    };
    
    // Start monitoring after a short delay
    setTimeout(checkProgress, 1000);
}

function toggleUpdateDetails() {
    const updateDetails = document.getElementById('updateDetails');
    const detailsIcon = document.getElementById('detailsIcon');
    
    if (updateDetails.style.display === 'none' || updateDetails.style.display === '') {
        updateDetails.style.display = 'block';
        detailsIcon.className = 'fas fa-chevron-up';
    } else {
        updateDetails.style.display = 'none';
        detailsIcon.className = 'fas fa-chevron-down';
    }
}

function showBackupManager() {
    $('#backupModal').modal('show');
    refreshBackupList();
}

function refreshBackupList() {
    const backupLoading = document.getElementById('backupLoading');
    const backupsList = document.getElementById('backupsList');
    const noBackups = document.getElementById('noBackups');
    
    backupLoading.style.display = 'block';
    backupsList.style.display = 'none';
    noBackups.style.display = 'none';
    
    $.get('/api/update/backups')
        .done(function(response) {
            if (response.success && response.data.length > 0) {
                renderBackupList(response.data);
                backupsList.style.display = 'block';
            } else {
                noBackups.style.display = 'block';
            }
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            backupsList.innerHTML = `<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤: ${error}</div>`;
            backupsList.style.display = 'block';
        })
        .always(function() {
            backupLoading.style.display = 'none';
        });
}

function renderBackupList(backups) {
    const backupsList = document.getElementById('backupsList');
    
    let html = '<div class="list-group">';
    
    backups.forEach((backup, index) => {
        const createdDate = new Date(backup.created_at).toLocaleString('ru-RU');
        const isRecent = index < 3;
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            ${backup.backup_id}
                            ${isRecent ? '<span class="badge bg-success ms-2">–ù–æ–≤—ã–π</span>' : ''}
                        </h6>
                        <p class="mb-1 small text-muted">
                            <i class="fas fa-clock"></i> ${createdDate} &nbsp;
                            <i class="fas fa-code-branch"></i> ${backup.commit_hash} &nbsp;
                            <i class="fas fa-tag"></i> ${backup.version} &nbsp;
                            <i class="fas fa-files-o"></i> ${backup.files_count} —Ñ–∞–π–ª–æ–≤ &nbsp;
                            <i class="fas fa-hdd"></i> ${backup.size_mb} MB
                        </p>
                    </div>
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-outline-info btn-sm" onclick="showBackupDetails('${backup.backup_id}')" title="–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏">
                            <i class="fas fa-info"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="confirmRestoreBackup('${backup.backup_id}')" title="–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    backupsList.innerHTML = html;
}

function showBackupDetails(backupId) {
    alert(`üìã –î–µ—Ç–∞–ª–∏ –±—ç–∫–∞–ø–∞: ${backupId}\n\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.\n–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º –±—ç–∫–∞–ø–∞.`);
}

function confirmRestoreBackup(backupId) {
    if (confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞\n\n–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∏–∑ –±—ç–∫–∞–ø–∞:\n${backupId}\n\nüö® –≠–¢–û –î–ï–ô–°–¢–í–ò–ï:\n‚Ä¢ –ó–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π –∫–æ–¥ –Ω–∞ –≤–µ—Ä—Å–∏—é –∏–∑ –±—ç–∫–∞–ø–∞\n‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ –±–æ—Ç—ã\n‚Ä¢ –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞\n‚Ä¢ –û—Ç–º–µ–Ω–∏—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ?`)) {
        alert('üöß –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –±—ç–∫–∞–ø–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.\n\n–î–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:\n1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n2. –ù–∞–π–¥–∏—Ç–µ –±—ç–∫–∞–ø –≤ –ø–∞–ø–∫–µ ./backups/\n3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é\n4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
    }
}

function cleanupBackups() {
    const keepCount = prompt('–°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤ –æ—Å—Ç–∞–≤–∏—Ç—å?', '5');
    
    if (keepCount === null) return;
    
    const count = parseInt(keepCount);
    if (isNaN(count) || count < 1) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ (–±–æ–ª—å—à–µ 0)');
        return;
    }
    
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ ${count} –ø–æ—Å–ª–µ–¥–Ω–∏—Ö?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        return;
    }
    
    $.ajax({
        url: '/api/update/backups/cleanup',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ keep_count: count })
    })
    .done(function(response) {
        if (response.success) {
            alert(`‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–£–¥–∞–ª–µ–Ω–æ –±—ç–∫–∞–ø–æ–≤: ${response.removed_count}\n–û—Å—Ç–∞–≤–ª–µ–Ω–æ: ${count}`);
            refreshBackupList();
        } else {
            alert(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${response.error}`);
        }
    })
    .fail(function(xhr) {
        const error = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        alert(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${error}`);
    });
}

function showBackupInfo() {
    alert(`‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –±—ç–∫–∞–ø–æ–≤\n\nüì¶ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –ë–≠–ö–ê–ü–´:\n‚Ä¢ –°–æ–∑–¥–∞—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º\n‚Ä¢ –í–∫–ª—é—á–∞—é—Ç –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã\n‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–æ–≤\n‚Ä¢ –§–∏–∫—Å–∏—Ä—É—é—Ç —Ç–µ–∫—É—â–∏–π Git commit\n\nüîÑ –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:\n‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤\n‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏—è—Ö –∏ —Ä–∞–∑–º–µ—Ä–∞—Ö\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤\n‚Ä¢ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)\n\nüìÅ –†–ê–°–ü–û–õ–û–ñ–ï–ù–ò–ï:\n./backups/ - –ø–∞–ø–∫–∞ —Å –±—ç–∫–∞–ø–∞–º–∏\n\nüõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨:\n–ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –ø—Ä–∏ —Å–±–æ—è—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.`);
}

// Authentication management
$(document).ready(function() {
    // Check authentication status on page load
    checkAuthStatus();
});

function checkAuthStatus() {
    const username = localStorage.getItem('auth_username');
    
    if (username) {
        // Update user display
        $('#currentUser').text(username);
        
        // Test authentication by making a request to the server
        $.ajax({
            url: '/api/v2/system/health',
            method: 'GET',
            timeout: 5000,
            success: function(response) {
                // Authentication is valid
                console.log('Authentication valid');
            },
            error: function(xhr) {
                if (xhr.status === 401) {
                    // Authentication failed, clear credentials and redirect to login
                    console.log('Authentication failed, redirecting to login');
                    localStorage.removeItem('auth_username');
                    window.location.href = '/login';
                }
            }
        });
    } else {
        // No credentials, redirect to login
        console.log('No credentials found, redirecting to login');
        window.location.href = '/login';
    }
}

function logout() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
        // Clear authentication data
        localStorage.removeItem('auth_username');
        
        // Redirect to logout page
        window.location.href = '/logout';
    }
}
</script>
</body></html>
