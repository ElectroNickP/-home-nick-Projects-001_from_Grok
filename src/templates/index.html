<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .status-running { color: green; font-weight: bold; }
        .status-stopped { color: red; font-weight: bold; }
        .spinner { display: none; }
        .table-responsive { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</h1>
    <div class="alert alert-warning" role="alert">
        ‚ö† –í–Ω–∏–º–∞–Ω–∏–µ: –ò–∑–º–µ–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ src/app.py (—Ä–∞–∑–¥–µ–ª USERS) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!
    </div>
    
    <!-- Version Info -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="text-muted small">
            <i class="fas fa-code-branch"></i> –í–µ—Ä—Å–∏—è: 
            <span class="fw-bold">{{ version }}</span>
            {% if version_details.is_dev %}
                <span class="badge bg-warning text-dark ms-1">DEV</span>
            {% endif %}
            <button class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal" data-bs-target="#versionModal">
                <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
            </button>
        </div>
        <div>
            <button id="checkUpdatesBtn" class="btn btn-outline-primary btn-sm me-2" onclick="checkForUpdates()">
                <i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            </button>
            <button id="updateBtn" class="btn btn-success btn-sm" onclick="performUpdate()" style="display: none;">
                <i class="fas fa-download"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <div id="updateStatus" class="text-muted small mt-1" style="display: none;"></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞</div>
        <div class="card-body">
            <form id="createBotForm">
                <div class="row g-3">
                    <div class="col-md-6"><input type="text" class="form-control" id="bot_name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="telegram_token" placeholder="Telegram Token" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="openai_api_key" placeholder="OpenAI API Key" required></div>
                    <div class="col-md-6"><input type="text" class="form-control" id="assistant_id" placeholder="Assistant ID" required></div>
                    <div class="col-md-6">
                        <input type="number" class="form-control" id="group_context_limit" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 15)" min="5" max="50" value="15">
                        <small class="form-text text-muted">–°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö</small>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enable_voice_responses" value="true">
                            <label class="form-check-label" for="enable_voice_responses">
                                üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
                            </label>
                        </div>
                        <small class="form-text text-muted">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≥–æ–ª–æ—Å–æ–º —á–µ—Ä–µ–∑ TTS</small>
                    </div>
                    <div class="col-md-6" id="voice_settings" style="display: none;">
                        <label class="form-label">–ú–æ–¥–µ–ª—å –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="voice_model">
                            <option value="tts-1">TTS-1 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                            <option value="tts-1-hd">TTS-1-HD (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
                        </select>
                    </div>
                    <div class="col-md-6" id="voice_type_settings" style="display: none;">
                        <label class="form-label">–¢–∏–ø –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="voice_type">
                            <option value="alloy">Alloy (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)</option>
                            <option value="echo">Echo (–º—É–∂—Å–∫–æ–π)</option>
                            <option value="fable">Fable (–±—Ä–∏—Ç–∞–Ω—Å–∫–∏–π)</option>
                            <option value="onyx">Onyx (–º—É–∂—Å–∫–æ–π, –≥–ª—É–±–æ–∫–∏–π)</option>
                            <option value="nova">Nova (–∂–µ–Ω—Å–∫–∏–π, –º–æ–ª–æ–¥–æ–π)</option>
                            <option value="shimmer">Shimmer (–∂–µ–Ω—Å–∫–∏–π, –º—è–≥–∫–∏–π)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary" id="createBtn">
                            <span class="spinner-border spinner-border-sm spinner" role="status"></span> –°–æ–∑–¥–∞—Ç—å
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <input type="text" class="form-control mb-3" id="searchBots" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">

    <h2 class="mb-3">–°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤</h2>
    <div class="table-responsive">
        <table class="table table-hover align-middle" id="botsTable">
            <thead class="table-dark">
                <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>Token</th><th>OpenAI Key</th><th>Assistant ID</th><th>–ö–æ–Ω—Ç–µ–∫—Å—Ç</th><th>TTS</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
            </thead>
            <tbody>
                {% for bot in bots %}
                <tr data-bot-id="{{ bot.id }}">
                    <td>{{ bot.id }}</td>
                    <td class="bot-name">{{ bot.config.bot_name }}</td>
                    <td class="bot-token text-break">{{ bot.config.telegram_token }}</td>
                    <td class="bot-openai text-break">{{ bot.config.openai_api_key }}</td>
                    <td class="bot-assistant">{{ bot.config.assistant_id }}</td>
                    <td class="bot-context">{{ bot.config.group_context_limit or 15 }}</td>
                    <td class="bot-voice">
                        {% if bot.config.enable_voice_responses %}
                            <span class="badge bg-success">üé§ –í–∫–ª</span><br>
                            <small class="text-muted">{{ bot.config.voice_type or 'alloy' }}</small>
                        {% else %}
                            <span class="badge bg-secondary">–í—ã–∫–ª</span>
                        {% endif %}
                    </td>
                    <td class="bot-status {% if bot.status == 'running' %}status-running{% else %}status-stopped{% endif %}">{{ bot.status }}</td>
                    <td>
                        <button class="btn btn-sm btn-success start-btn" {% if bot.status == 'running' %}disabled{% endif %}>–°—Ç–∞—Ä—Ç</button>
                        <button class="btn btn-sm btn-warning stop-btn" {% if bot.status != 'running' %}disabled{% endif %}>–°—Ç–æ–ø</button>
                        <button class="btn btn-sm btn-info edit-btn">–ü—Ä–∞–≤–∏—Ç—å</button>
                        <button class="btn btn-sm btn-danger delete-btn">–£–¥–∞–ª–∏—Ç—å</button>
                        <a href="/dialogs/{{ bot.id }}" class="btn btn-sm btn-primary">–î–∏–∞–ª–æ–≥–∏</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="editBotForm">
                <input type="hidden" id="edit_bot_id">
                <div class="mb-3"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="form-control" id="edit_bot_name" required></div>
                <div class="mb-3"><label class="form-label">Telegram Token</label><input type="text" class="form-control" id="edit_telegram_token" required></div>
                <div class="mb-3"><label class="form-label">OpenAI API Key</label><input type="text" class="form-control" id="edit_openai_api_key" required></div>
                <div class="mb-3"><label class="form-label">Assistant ID</label><input type="text" class="form-control" id="edit_assistant_id" required></div>
                <div class="mb-3">
                    <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</label>
                    <input type="number" class="form-control" id="edit_group_context_limit" min="5" max="50" value="15">
                    <small class="form-text text-muted">–°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤ –≥—Ä—É–ø–ø–∞—Ö</small>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_enable_voice_responses" value="true">
                        <label class="form-check-label" for="edit_enable_voice_responses">
                            üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã
                        </label>
                    </div>
                    <small class="form-text text-muted">–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç—ã –≥–æ–ª–æ—Å–æ–º —á–µ—Ä–µ–∑ TTS</small>
                </div>
                <div class="row" id="edit_voice_settings" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label">–ú–æ–¥–µ–ª—å –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="edit_voice_model">
                            <option value="tts-1">TTS-1 (–ë—ã—Å—Ç—Ä–∞—è)</option>
                            <option value="tts-1-hd">TTS-1-HD (–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">–¢–∏–ø –≥–æ–ª–æ—Å–∞</label>
                        <select class="form-select" id="edit_voice_type">
                            <option value="alloy">Alloy (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)</option>
                            <option value="echo">Echo (–º—É–∂—Å–∫–æ–π)</option>
                            <option value="fable">Fable (–±—Ä–∏—Ç–∞–Ω—Å–∫–∏–π)</option>
                            <option value="onyx">Onyx (–º—É–∂—Å–∫–æ–π, –≥–ª—É–±–æ–∫–∏–π)</option>
                            <option value="nova">Nova (–∂–µ–Ω—Å–∫–∏–π, –º–æ–ª–æ–¥–æ–π)</option>
                            <option value="shimmer">Shimmer (–∂–µ–Ω—Å–∫–∏–π, –º—è–≥–∫–∏–π)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="saveEditBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div></div>
</div>

<!-- Version Details Modal -->
<div class="modal fade" id="versionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-tag text-success"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏—è:</strong></td>
                                <td>{{ version_details.version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í–µ—Ç–∫–∞:</strong></td>
                                <td>
                                    <span class="badge bg-{% if version_details.branch == 'main' %}success{% else %}warning{% endif %}">
                                        {{ version_details.branch }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–¢–∏–ø —Å–±–æ—Ä–∫–∏:</strong></td>
                                <td>
                                    {% if version_details.is_dev %}
                                        <span class="badge bg-warning text-dark">–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞</span>
                                    {% else %}
                                        <span class="badge bg-success">–ü—Ä–æ–¥–∞–∫—à–Ω</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-code-branch text-info"></i> Git –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ö–æ–º–º–∏—Ç:</strong></td>
                                <td><code>{{ version_details.commit_hash }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>–î–∞—Ç–∞ –∫–æ–º–º–∏—Ç–∞:</strong></td>
                                <td>{{ version_details.commit_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong></td>
                                <td class="text-muted small">{{ version_details.commit_message[:50] }}{% if version_details.commit_message|length > 50 %}...{% endif %}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs text-secondary"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Python:</strong></td>
                                <td>{{ version_details.python_version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:</strong></td>
                                <td>{{ version_details.build_time }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-rocket text-primary"></i> –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h6>
                        <ul class="list-unstyled small">
                            <li><i class="fas fa-check text-success"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Telegram –±–æ—Ç–∞–º–∏</li>
                            <li><i class="fas fa-check text-success"></i> OpenAI Assistant API</li>
                            <li><i class="fas fa-check text-success"></i> –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</li>
                            <li><i class="fas fa-check text-success"></i> –ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞</li>
                            <li><i class="fas fa-check text-success"></i> –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="checkForUpdates()">
                    <i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
$(document).ready(function() {
    function apiCall(url, method, data, btn) {
        if (btn) $(btn).prop('disabled', true);
        $.ajax({
            url: url, method: method, contentType: "application/json", data: JSON.stringify(data),
            success: () => location.reload(),
            error: (xhr) => {
                alert("–û—à–∏–±–∫–∞: " + (xhr.responseJSON?.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"));
                if (btn) $(btn).prop('disabled', false);
            }
        });
    }
    $("#createBotForm").submit(e => {
        e.preventDefault();
        apiCall("/api/bots", "POST", {
            bot_name: $("#bot_name").val(), telegram_token: $("#telegram_token").val(),
            openai_api_key: $("#openai_api_key").val(), assistant_id: $("#assistant_id").val(),
            group_context_limit: parseInt($("#group_context_limit").val()) || 15,
            enable_voice_responses: $("#enable_voice_responses").is(':checked'),
            voice_model: $("#voice_model").val() || "tts-1",
            voice_type: $("#voice_type").val() || "alloy"
        }, '#createBtn');
    });
    $('#botsTable').on('click', '.edit-btn', function() {
        var row = $(this).closest('tr');
        var botId = row.data("bot-id");
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        $.get(`/api/bots/${botId}`)
            .done(function(bot) {
                $("#edit_bot_id").val(bot.id);
                $("#edit_bot_name").val(bot.config.bot_name);
                $("#edit_telegram_token").val(bot.config.telegram_token);
                $("#edit_openai_api_key").val(bot.config.openai_api_key);
                $("#edit_assistant_id").val(bot.config.assistant_id);
                $("#edit_group_context_limit").val(bot.config.group_context_limit || 15);
                
                // TTS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                $("#edit_enable_voice_responses").prop('checked', bot.config.enable_voice_responses || false);
                $("#edit_voice_model").val(bot.config.voice_model || "tts-1");
                $("#edit_voice_type").val(bot.config.voice_type || "alloy");
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞
                if (bot.config.enable_voice_responses) {
                    $("#edit_voice_settings").show();
                } else {
                    $("#edit_voice_settings").hide();
                }
                
                new bootstrap.Modal('#editModal').show();
            })
            .fail(function() {
                // Fallback –∫ —Å—Ç–∞—Ä–æ–º—É –º–µ—Ç–æ–¥—É –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                $("#edit_bot_id").val(botId);
                $("#edit_bot_name").val(row.find(".bot-name").text());
                $("#edit_telegram_token").val(row.find(".bot-token").text());
                $("#edit_openai_api_key").val(row.find(".bot-openai").text());
                $("#edit_assistant_id").val(row.find(".bot-assistant").text());
                $("#edit_group_context_limit").val(row.find(".bot-context").text() || 15);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è TTS
                $("#edit_enable_voice_responses").prop('checked', false);
                $("#edit_voice_model").val("tts-1");
                $("#edit_voice_type").val("alloy");
                $("#edit_voice_settings").hide();
                
                new bootstrap.Modal('#editModal').show();
            });
    });
    $("#editBotForm").submit(e => {
        e.preventDefault();
        var botId = $("#edit_bot_id").val();
        apiCall(`/api/bots/${botId}`, "PUT", {
            bot_name: $("#edit_bot_name").val(), telegram_token: $("#edit_telegram_token").val(),
            openai_api_key: $("#edit_openai_api_key").val(), assistant_id: $("#edit_assistant_id").val(),
            group_context_limit: parseInt($("#edit_group_context_limit").val()) || 15,
            enable_voice_responses: $("#edit_enable_voice_responses").is(':checked'),
            voice_model: $("#edit_voice_model").val() || "tts-1",
            voice_type: $("#edit_voice_type").val() || "alloy"
        }, '#saveEditBtn');
    });
    $('#botsTable').on('click', '.delete-btn', function() {
        if (confirm("–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞?")) apiCall(`/api/bots/${$(this).closest('tr').data('bot-id')}`, "DELETE", null, this);
    });
    $('#botsTable').on('click', '.start-btn', function() { apiCall(`/api/bots/${$(this).closest('tr').data('bot-id')}/start`, "POST", null, this); });
    $('#botsTable').on('click', '.stop-btn', function() { apiCall(`/api/bots/${$(this).closest('tr').data('bot-id')}/stop`, "POST", null, this); });
    $("#searchBots").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        $("#botsTable tbody tr").toggle(function() { return $(this).find(".bot-name").text().toLowerCase().indexOf(value) > -1; });
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è)
    $("#enable_voice_responses").change(function() {
        if ($(this).is(':checked')) {
            $("#voice_settings, #voice_type_settings").show();
        } else {
            $("#voice_settings, #voice_type_settings").hide();
        }
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–æ–ª–æ—Å–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    $("#edit_enable_voice_responses").change(function() {
        if ($(this).is(':checked')) {
            $("#edit_voice_settings").show();
        } else {
            $("#edit_voice_settings").hide();
        }
    });
});

function checkForUpdates() {
    const btn = document.getElementById('checkUpdatesBtn');
    const updateBtn = document.getElementById('updateBtn');
    const statusDiv = document.getElementById('updateStatus');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    btn.disabled = true;
    updateBtn.style.display = 'none';
    statusDiv.style.display = 'none';
    
    $.get('/api/check-updates')
        .done(function(data) {
            if (data.has_updates) {
                let message = `–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ!\n\n`;
                message += `–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: ${data.local_commit}\n`;
                message += `–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: ${data.remote_commit}\n\n`;
                
                if (data.new_commits && data.new_commits.length > 0) {
                    message += `–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:\n`;
                    data.new_commits.forEach(commit => {
                        message += `‚Ä¢ ${commit}\n`;
                    });
                }
                
                statusDiv.innerHTML = '<i class="fas fa-arrow-up text-success"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ!';
                statusDiv.style.display = 'block';
                updateBtn.style.display = 'inline-block';
                
                alert(message);
            } else {
                statusDiv.innerHTML = '<i class="fas fa-check text-success"></i> –£ –≤–∞—Å –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è!';
                statusDiv.style.display = 'block';
                updateBtn.style.display = 'none';
            }
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: ' + error);
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
            statusDiv.style.display = 'block';
        })
        .always(function() {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
            btn.disabled = false;
        });
}

function performUpdate() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ?\n\n–í–æ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:\n‚Ä¢ –í—Å–µ –±–æ—Ç—ã –±—É–¥—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\n‚Ä¢ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ\n‚Ä¢ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
        return;
    }
    
    const btn = document.getElementById('updateBtn');
    const checkBtn = document.getElementById('checkUpdatesBtn');
    const statusDiv = document.getElementById('updateStatus');
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    btn.disabled = true;
    checkBtn.disabled = true;
    
    statusDiv.innerHTML = '<i class="fas fa-download text-primary"></i> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    statusDiv.style.display = 'block';
    
    $.post('/api/update')
        .done(function(data) {
            alert('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n\n–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');
            
            statusDiv.innerHTML = '<i class="fas fa-sync fa-spin text-success"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...';
            
            // –ñ–¥–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(function() {
                window.location.reload();
            }, 5000);
        })
        .fail(function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + error);
            
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
            
            btn.innerHTML = '<i class="fas fa-download"></i> –û–±–Ω–æ–≤–∏—Ç—å';
            btn.disabled = false;
            checkBtn.disabled = false;
        });
}
</script>
</body></html>
